<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdeTim - AI Email Assistant</title>
    <script src="https://accounts.google.com" async defer></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        #chat-container { width: 450px; height: 600px; background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        #header { background: #d93025; color: white; padding: 15px; text-align: center; font-weight: bold; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        #chatbox { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #eee; }
        .msg { padding: 10px 14px; border-radius: 15px; max-width: 80%; font-size: 14px; }
        .user { align-self: flex-end; background: #d93025; color: white; }
        .bot { align-self: flex-start; background: #f1f3f4; color: #202124; }
        #input-area { padding: 15px; display: flex; gap: 10px; }
        input { flex: 1; border: 1px solid #ddd; border-radius: 20px; padding: 10px 15px; outline: none; }
        button { background: #d93025; border: none; color: white; border-radius: 20px; padding: 0 20px; cursor: pointer; }
        .auth-btn { background: white; color: #d93025; border: 1px solid white; padding: 5px 10px; font-size: 12px; border-radius: 4px; }
    </style>
</head>
<body>

<div id="chat-container">
    <div id="header">
        AdeTim Assistant
        <button class="auth-btn" onclick="handleAuthClick()">Login Gmail</button>
    </div>
    <div id="chatbox">
        <div class="msg bot">Hello! I'm AdeTim. Log in to Gmail, and I can draft or send emails for you.</div>
    </div>
    <div id="input-area">
        <input type="text" id="user-input" placeholder="e.g., Draft a follow-up to Mark">
        <button onclick="sendMessage()">Send</button>
    </div>
</div>

<script>
    const OPENAI_KEY = "YOUR_OPENAI_API_KEY";
    const CLIENT_ID = "YOUR_GOOGLE_CLIENT_ID";
    const DISCOVERY_DOC = "https://www.googleapis.com";
    const SCOPES = "https://www.googleapis.com https://www.googleapis.com";

    let tokenClient;
    let gapiInited = false;
    let gisInited = false;
    let chatHistory = [{ role: "system", content: "You are AdeTim, an AI assistant. You can use tools to draft or send emails." }];

    // 1. Initialize Gmail API
    function handleAuthClick() {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: SCOPES,
            callback: (resp) => { if (resp.access_token) sendMessage("I am now logged in!"); },
        });
        tokenClient.requestAccessToken({prompt: 'consent'});
    }

    // 2. Main Logic: LLM + Tool Handling
    async function sendMessage(overrideText = null) {
        const input = document.getElementById('user-input');
        const text = overrideText || input.value.trim();
        if (!text) return;

        appendMsg(text, 'user');
        input.value = "";
        chatHistory.push({ role: "user", content: text });

        const response = await fetch("https://api.openai.com", {
            method: "POST",
            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${OPENAI_KEY}` },
            body: JSON.stringify({
                model: "gpt-4o",
                messages: chatHistory,
                tools: [{
                    type: "function",
                    function: {
                        name: "manage_email",
                        description: "Draft or send an email via Gmail",
                        parameters: {
                            type: "object",
                            properties: {
                                action: { type: "string", enum: ["draft", "send"] },
                                to: { type: "string" },
                                subject: { type: "string" },
                                body: { type: "string" }
                            },
                            required: ["action", "to", "body"]
                        }
                    }
                }]
            })
        });

        const data = await response.json();
        const msg = data.choices[0].message;

        if (msg.tool_calls) {
            const tool = msg.tool_calls[0].function;
            const args = JSON.parse(tool.arguments);
            executeGmailTool(args);
        } else {
            appendMsg(msg.content, 'bot');
            chatHistory.push({ role: "assistant", content: msg.content });
        }
    }

    // 3. Gmail Tool Execution
    async function executeGmailTool(args) {
        appendMsg(`Actioning: ${args.action} email to ${args.to}...`, 'bot');
        const email = `To: ${args.to}\r\nSubject: ${args.subject || 'No Subject'}\r\n\r\n${args.body}`;
        const base64Email = btoa(unescape(encodeURIComponent(email))).replace(/\+/g, '-').replace(/\//g, '_');

        const endpoint = args.action === "draft" ? "drafts" : "messages/send";
        const body = args.action === "draft" ? { message: { raw: base64Email } } : { raw: base64Email };

        await fetch(`https://gmail.googleapis.com{endpoint}`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${gapi.client.getToken().access_token}`, "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });
        appendMsg(`Success! Email ${args.action}ed.`, 'bot');
    }

    function appendMsg(t, s) {
        const cb = document.getElementById('chatbox');
        const d = document.createElement('div');
        d.className = `msg ${s}`;
        d.innerText = t;
        cb.appendChild(d);
        cb.scrollTop = cb.scrollHeight;
    }
</script>
<script src="https://apis.google.com"></script>
</body>
</html>
